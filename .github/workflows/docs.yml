name: docs

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: "17 2 * * *" # daily 02:17 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: true
      - name: Install deps
        run: poetry install --no-interaction --no-root
      - name: Normalize redirects
        run: poetry run python tools/normalize_redirect_maps.py || echo "⚠️  normalize_redirect_maps.py not found, skipping"
      - name: Copy assets into locales
        run: |
          for lang in de fr es pt; do
            if [ -d "docs/$lang" ]; then
              mkdir -p "docs/$lang"
              rm -rf "docs/$lang/assets"
              cp -R "docs/assets" "docs/$lang/assets" || echo "⚠️  Assets copy failed for $lang"
            fi
          done
      - name: Lint config
        run: |
          # Проверяем только наши файлы, игнорируя .venv
          poetry run yamllint mkdocs.yml .github/workflows/*.yml tools/glossary.yaml
      - name: Fix image paths
        env:
          DRY_RUN: "0"
        run: |
          poetry run python tools/fix_image_paths.py --apply || true

      - name: Check anchors (pass 1)
        continue-on-error: true
        run: |
          poetry run python tools/anchors_doctor.py --dry-run \
            --exclude "release-notes.md" \
            --exclude "de/release-notes.md" \
            --skip-images

      - name: Apply safe anchor fixes
        run: |
          if [ -f build/anchors_report.csv ]; then
            poetry run python tools/anchors_autofix.py \
              --docs docs \
              --report build/anchors_report.csv || true
          else
            echo "No anchors report found, skipping autofix"
          fi

      - name: Inject legacy anchors (auto-fix)
        run: |
          if [ -f build/anchors_report.csv ]; then
            poetry run python tools/anchors_legacy_inject.py \
              --docs docs \
              --report build/anchors_report.csv \
              --apply
          else
            echo "No anchors report found, skipping legacy anchors inject"
          fi

      - name: Debug anchors reports
        run: |
          ls -la build || true
          python3 - <<'PY'
          import csv
          import pathlib
          p = pathlib.Path("build/anchors_report.csv")
          if p.exists():
            with open(p, 'r', encoding='utf-8') as f:
              reader = csv.DictReader(f)
              rows = list(reader)
              statuses = {}
              for row in rows:
                status = row.get('status', '')
                statuses[status] = statuses.get(status, 0) + 1
              print("anchors_report statuses:", statuses)
          else:
            print("anchors_report.csv missing")
          PY

      - name: Check anchors (pass 2)
        run: |
          poetry run python tools/anchors_doctor.py --dry-run \
            --exclude "release-notes.md" \
            --exclude "de/release-notes.md" \
            --skip-images
      - name: Build docs (strict)
        run: |
          set +e
          poetry run mkdocs build -s 2>&1 | tee /tmp/mkdocs_build.log
          BUILD_EXIT=$?
          # Count redirect warnings (these are expected and should be ignored)
          REDIRECT_WARNINGS=$(grep -c "WARNING.*redirects plugin:.*is not a valid markdown file" /tmp/mkdocs_build.log || echo "0")
          # Count other warnings (exclude redirect warnings more precisely)
          OTHER_WARNINGS=$(grep "^WARNING" /tmp/mkdocs_build.log | grep -v "redirects plugin:.*is not a valid markdown file" | wc -l | tr -d ' ')
          echo "Redirect warnings: $REDIRECT_WARNINGS (ignored)"
          echo "Other warnings: $OTHER_WARNINGS"
          if [ "$OTHER_WARNINGS" -gt 0 ]; then
            echo "::error::Found $OTHER_WARNINGS non-redirect warnings"
            echo "First 10 other warnings:"
            grep "^WARNING" /tmp/mkdocs_build.log | grep -v "redirects plugin:.*is not a valid markdown file" | head -10
            exit 1
          fi
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "::error::Build failed with exit code $BUILD_EXIT"
            exit $BUILD_EXIT
          fi
          echo "✅ Build completed successfully"

      - name: Upload CSV reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-reports
          path: |
            build/*.csv
          retention-days: 30

      - name: Check reports (toggles for anchors/images/redirects)
        if: github.ref == 'refs/heads/main'
        env:
          SKIP_ANCHORS: "1" # ← temporarily skip, set "0" after autofix stabilizes
          SKIP_IMAGES: "1" # ← temporarily skip, set "0" when images are fixed
          SKIP_REDIRECTS: "1" # ← temporarily skip, set "0" when redirects are configured
        run: |
          set -euo pipefail
          echo "Report sizes (lines):"
          for f in build/anchors_report.csv build/images_report.csv build/redirects_unmapped.csv; do
            if [ -f "$f" ]; then echo "  $(wc -l < "$f")  $f"; else echo "  0  $f (missing)"; fi
          done

          fail=0
          check() {
            local f="$1" label="$2" ignore="${3:-0}"
            if [ -f "$f" ] && [ $(wc -l < "$f") -gt 1 ]; then
              if [ "$ignore" = "1" ]; then
                echo "::warning file=$f::$label (non-empty, ignored for now)"
              else
                echo "::error file=$f::$label"
                fail=1
              fi
            fi
          }

          check build/anchors_report.csv "Broken anchors report" "${SKIP_ANCHORS}"
          check build/images_report.csv "Image issues report" "${SKIP_IMAGES}"
          check build/redirects_unmapped.csv "Unmapped redirects report" "${SKIP_REDIRECTS}"

          exit $fail

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: true
      - run: poetry install --no-interaction --no-root
      - name: Normalize redirects
        run: poetry run python tools/normalize_redirect_maps.py || echo "⚠️  normalize_redirect_maps.py not found, skipping"
      - name: Copy assets into locales
        run: |
          for lang in de fr es pt; do
            if [ -d "docs/$lang" ]; then
              mkdir -p "docs/$lang"
              rm -rf "docs/$lang/assets"
              cp -R "docs/assets" "docs/$lang/assets" || echo "⚠️  Assets copy failed for $lang"
            fi
          done
      - run: |
          set +e
          poetry run mkdocs build -s 2>&1 | tee /tmp/mkdocs_build.log
          BUILD_EXIT=$?
          # Count redirect warnings (these are expected and should be ignored)
          REDIRECT_WARNINGS=$(grep -c "WARNING.*redirects plugin:.*is not a valid markdown file" /tmp/mkdocs_build.log || echo "0")
          # Count other warnings (exclude redirect warnings more precisely)
          OTHER_WARNINGS=$(grep "^WARNING" /tmp/mkdocs_build.log | grep -v "redirects plugin:.*is not a valid markdown file" | wc -l | tr -d ' ')
          echo "Redirect warnings: $REDIRECT_WARNINGS (ignored)"
          echo "Other warnings: $OTHER_WARNINGS"
          if [ "$OTHER_WARNINGS" -gt 0 ]; then
            echo "::error::Found $OTHER_WARNINGS non-redirect warnings"
            echo "First 10 other warnings:"
            grep "^WARNING" /tmp/mkdocs_build.log | grep -v "redirects plugin:.*is not a valid markdown file" | head -10
            exit 1
          fi
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "::error::Build failed with exit code $BUILD_EXIT"
            exit $BUILD_EXIT
          fi
          echo "✅ Build completed successfully"
      - name: Deploy to Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          cname: docs.aqtra.io
          force_orphan: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"

  nightly-links:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: true
      - name: Install deps
        run: poetry install --no-interaction --no-root
      - name: Normalize redirects
        run: poetry run python tools/normalize_redirect_maps.py || echo "⚠️  normalize_redirect_maps.py not found, skipping"
      - name: Copy assets into locales
        run: |
          for lang in de fr es pt; do
            if [ -d "docs/$lang" ]; then
              mkdir -p "docs/$lang"
              rm -rf "docs/$lang/assets"
              cp -R "docs/assets" "docs/$lang/assets" || echo "⚠️  Assets copy failed for $lang"
            fi
          done
      - name: Build docs
        run: |
          set +e
          poetry run mkdocs build -s 2>&1 | tee /tmp/mkdocs_build.log
          BUILD_EXIT=$?
          # Count redirect warnings (these are expected and should be ignored)
          REDIRECT_WARNINGS=$(grep -c "WARNING.*redirects plugin:.*is not a valid markdown file" /tmp/mkdocs_build.log || echo "0")
          # Count other warnings (exclude redirect warnings more precisely)
          OTHER_WARNINGS=$(grep "^WARNING" /tmp/mkdocs_build.log | grep -v "redirects plugin:.*is not a valid markdown file" | wc -l | tr -d ' ')
          echo "Redirect warnings: $REDIRECT_WARNINGS (ignored)"
          echo "Other warnings: $OTHER_WARNINGS"
          if [ "$OTHER_WARNINGS" -gt 0 ]; then
            echo "::error::Found $OTHER_WARNINGS non-redirect warnings"
            echo "First 10 other warnings:"
            grep "^WARNING" /tmp/mkdocs_build.log | grep -v "redirects plugin:.*is not a valid markdown file" | head -10
            exit 1
          fi
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "::error::Build failed with exit code $BUILD_EXIT"
            exit $BUILD_EXIT
          fi
          echo "✅ Build completed successfully"
      - name: Check links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --no-progress --max-redirects 10 --accept 200,206,429 "docs/**/*.md"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
