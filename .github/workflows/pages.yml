name: Docs → GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install dependencies
        run: |
          set -e
          python -V
          pip install -U pip
          pip install -r requirements.txt
          echo "---- versions ----"
          mkdocs --version
          python - <<'PY'
          import importlib.metadata as im
          pkgs = [
            "mkdocs","mkdocs-material","mkdocs-static-i18n","mkdocs-redirects",
            "mkdocs-glightbox","mkdocs-mermaid2-plugin",
            "mkdocs-git-revision-date-localized-plugin","mkdocs-minify-plugin",
            "mkdocstrings","mkdocs-autorefs"
          ]
          installed = {d.metadata.get("Name","").lower(): d.version for d in im.distributions()}
          print({p: installed.get(p.lower(), "missing") for p in pkgs})
          PY

      - name: Build site (MkDocs)
        run: mkdocs build --strict --verbose

      - name: Move default build to /en/ and create redirect
        run: |
          # Move built English docs (from root) to /en/
          mkdir -p site/en
          # Move all root files/dirs except de/ and assets/ to /en/
          for item in site/*; do
            base=$(basename "$item")
            if [ "$base" != "de" ] && [ "$base" != "assets" ] && [ "$base" != "en" ]; then
              mv "$item" site/en/
            fi
          done

          # Create root redirect to /en/
          cat > site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting to Aqtra Docs</title>
            <meta http-equiv="refresh" content="0; URL=/en/">
            <link rel="canonical" href="https://docs.aqtra.io/en/">
            <script>window.location.replace("/en/" + window.location.hash);</script>
          </head>
          <body>
            <p>Redirecting to <a href="/en/">Aqtra Documentation</a>...</p>
          </body>
          </html>
          EOF

      - name: Mirror assets into language folders (safety net)
        run: |
          set -e
          for L in en de; do
            mkdir -p "site/$L/assets"
            rsync -a --delete "site/assets/" "site/$L/assets/"
          done
          echo "✅ Assets mirrored to /en/assets and /de/assets"

      - name: Generate legacy redirects for /en/app-develop/**
        run: |
          set -e
          SRC="site/en/app-development"
          DST="site/en/app-develop"
          if [ -d "$SRC" ]; then
            # Create redirect for EVERY html in new structure
            while IFS= read -r -d '' f; do
              rel="${f#${SRC}/}"                # relative path, e.g.: ui-components/wysiwyg-editor.html
              out="${DST}/${rel}"               # where to put redirect
              mkdir -p "$(dirname "$out")"
              target="/en/app-development/${rel}"
              cat > "$out" <<EOF
          <!doctype html><html lang="en"><head>
            <meta charset="utf-8">
            <title>Moved</title>
            <link rel="canonical" href="${target}">
            <meta http-equiv="refresh" content="0; url=${target}">
            <script>location.replace("${target}"+location.search+location.hash)</script>
            <noscript><meta http-equiv="refresh" content="0; url=${target}"></noscript>
          </head><body>
            <a href="${target}">This page has moved to ${target}</a>
          </body></html>
          EOF
            done < <(find "$SRC" -type f -name '*.html' -print0)
            echo "✅ Generated $(find "$DST" -type f -name '*.html' | wc -l) redirect pages"
          fi

      - name: Add specific legacy redirects
        run: |
          set -e
          # /en/overview1/first-entry.html → /en/overview/getting-started.html#first
          mkdir -p site/en/overview1
          cat > site/en/overview1/first-entry.html <<'EOF'
          <!doctype html><html lang="en"><head>
            <meta charset="utf-8">
            <title>Moved</title>
            <link rel="canonical" href="/en/overview/getting-started.html#first">
            <meta http-equiv="refresh" content="0; url=/en/overview/getting-started.html#first">
            <script>location.replace("/en/overview/getting-started.html#first"+location.search)</script>
          </head><body>
            <a href="/en/overview/getting-started.html#first">This page has moved</a>
          </body></html>
          EOF
          echo "✅ Added specific redirects"

      - name: Add CNAME and .nojekyll
        run: |
          echo "docs.aqtra.io" > site/CNAME
          touch site/.nojekyll

      - name: Verify build output
        run: |
          set -e
          echo "Checking critical files:"
          test -f site/en/index.html && echo "✅ EN index.html"
          test -f site/de/index.html && echo "✅ DE index.html"
          test -f site/index.html && echo "✅ Root index.html (redirect)"
          test -f site/CNAME && echo "✅ CNAME"
          test -f site/.nojekyll && echo "✅ .nojekyll"

          echo ""
          echo "Material theme assets (root /assets):"
          ls -1 site/assets/stylesheets/ | grep -E '^main\..*\.min\.css$' && echo "✅ Material main CSS"
          ls -1 site/assets/stylesheets/ | grep -E '^palette\..*\.min\.css$' && echo "✅ Material palette CSS"
          ls -1 site/assets/javascripts/ | grep -E '^bundle\..*\.min\.js$' && echo "✅ Material bundle JS"

          echo ""
          echo "Custom assets (root /assets):"
          test -f site/assets/css/extra.css && echo "✅ Custom extra.css"
          test -f site/assets/css/back-to-top.css && echo "✅ Back-to-top CSS"
          test -f site/assets/js/nav-anchor.js && echo "✅ Nav anchor JS"
          test -f site/assets/js/back-to-top.js && echo "✅ Back-to-top JS"

          echo ""
          echo "Mirrored assets in /en/assets (safety net):"
          MAIN_CSS=$(ls site/assets/stylesheets/ | grep -E '^main\..*\.min\.css$' | head -n1)
          BUNDLE_JS=$(ls site/assets/javascripts/ | grep -E '^bundle\..*\.min\.js$' | head -n1)
          test -f "site/en/assets/stylesheets/$MAIN_CSS" && echo "✅ EN has Material main CSS"
          test -f "site/en/assets/javascripts/$BUNDLE_JS" && echo "✅ EN has Material bundle JS"

          echo ""
          echo "Branding:"
          test -f site/assets/favicon.svg && echo "✅ Favicon SVG"
          test -f site/assets/favicon.ico && echo "✅ Favicon ICO (fallback)" || true
          test -f site/assets/images/logo-light.svg && echo "✅ Logo"

          echo ""
          echo "Language switcher & redirects:"
          grep -q 'href="/de/' site/en/index.html && echo "✅ Language link is absolute (/de/)"
          grep -q 'redirect-legacy-paths.js' site/en/index.html && echo "✅ Legacy redirect script loaded"

          echo ""
          echo "Legacy redirect pages:"
          test -f site/en/app-develop/ui-components/wysiwyg-editor.html && echo "✅ Redirect: app-develop/ui-components/wysiwyg-editor.html"
          test -f site/en/app-develop/data-flow-components/subscribe-to-connector.html && echo "✅ Redirect: app-develop/data-flow-components/subscribe-to-connector.html"
          test -f site/en/overview1/first-entry.html && echo "✅ Redirect: overview1/first-entry.html"
          echo "Total legacy redirects: $(find site/en/app-develop -type f -name '*.html' 2>/dev/null | wc -l)"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
